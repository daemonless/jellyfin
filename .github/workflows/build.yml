name: Build FreeBSD Container

on:
  push:
    branches: [main]
    paths-ignore: ['*.md', 'LICENSE', '.gitignore']
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ghcr.io/daemonless/jellyfin

jobs:
  build-latest:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build in FreeBSD VM
        uses: vmactions/freebsd-vm@v1.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          release: "15.0"
          usesh: true
          copyback: false
          envs: "GITHUB_TOKEN GITHUB_ACTOR"
          prepare: |
            pkg install -y podman doas
            echo "permit nopass keepenv :wheel" > /usr/local/etc/doas.conf
            kldload pf
            sysctl net.inet.ip.forwarding=1
          run: |
            set -e

            # Build Jellyfin on bare metal (not in jail) - .NET requires allow.mlock
            echo "==> Building Jellyfin on bare metal..."
            chmod +x scripts/build-jellyfin.sh
            ./scripts/build-jellyfin.sh

            # Now build container image with pre-built artifacts
            echo "==> Building container image..."
            doas podman build -f Containerfile -t ${{ env.IMAGE_NAME }}:latest .

            # Extract version for tagging
            VERSION=$(cat build-output/version)
            echo "Built Jellyfin ${VERSION}"
            doas podman tag ${{ env.IMAGE_NAME }}:latest ${{ env.IMAGE_NAME }}:${VERSION}

            # Push if not a PR
            if [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "==> Logging in to registry..."
              echo "$GITHUB_TOKEN" | doas podman login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

              echo "==> Pushing images..."
              doas podman push ${{ env.IMAGE_NAME }}:latest
              doas podman push ${{ env.IMAGE_NAME }}:${VERSION}
            fi

  build-pkg:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build pkg variants in FreeBSD VM
        uses: vmactions/freebsd-vm@v1.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_ACTOR: ${{ github.actor }}
        with:
          release: "15.0"
          usesh: true
          copyback: false
          envs: "GITHUB_TOKEN GITHUB_ACTOR"
          prepare: |
            pkg install -y podman doas
            echo "permit nopass keepenv :wheel" > /usr/local/etc/doas.conf
            kldload pf
            sysctl net.inet.ip.forwarding=1
          run: |
            set -e

            # Build :pkg (quarterly packages)
            echo "==> Building :pkg variant..."
            doas podman build -f Containerfile.pkg \
              --build-arg BASE_VERSION=15-quarterly \
              -t ${{ env.IMAGE_NAME }}:pkg .

            # Build :pkg-latest (latest packages)
            echo "==> Building :pkg-latest variant..."
            doas podman build -f Containerfile.pkg \
              --build-arg BASE_VERSION=15 \
              -t ${{ env.IMAGE_NAME }}:pkg-latest .

            # Push if not a PR
            if [ "${{ github.event_name }}" != "pull_request" ]; then
              echo "==> Logging in to registry..."
              echo "$GITHUB_TOKEN" | doas podman login ghcr.io -u "$GITHUB_ACTOR" --password-stdin

              echo "==> Pushing images..."
              doas podman push ${{ env.IMAGE_NAME }}:pkg
              doas podman push ${{ env.IMAGE_NAME }}:pkg-latest
            fi
